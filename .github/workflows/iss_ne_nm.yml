name: Issue Real-time Notification

on:
  issues:
    types: [opened, closed, reopened, assigned, labeled, unlabeled]

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  issue-notification:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check Out Repository
        uses: actions/checkout@v4
      
      - name: Prepare Issue Message
        id: prepare_message
        run: |
          ISSUE_TITLE="${{ github.event.issue.title }}"
          ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          ISSUE_STATE="${{ github.event.issue.state }}"
          ISSUE_ACTION="${{ github.event.action }}"
          
          echo "å¤„ç†äº‹ä»¶: $ISSUE_ACTION (Issue #$ISSUE_NUMBER)"
          
          # å¦‚æœæ˜¯ opened äº‹ä»¶ï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´æ£€æŸ¥å®Œæ•´çŠ¶æ€
          if [ "$ISSUE_ACTION" == "opened" ]; then
            echo "æ£€æµ‹åˆ°æ–°å»º Issueï¼Œç­‰å¾…30ç§’æ£€æŸ¥å®Œæ•´çŠ¶æ€..."
            sleep 30
            
            # è°ƒç”¨ API è·å– Issue çš„å®Œæ•´çŠ¶æ€
            echo "è·å– Issue #$ISSUE_NUMBER çš„å®Œæ•´çŠ¶æ€..."
            ISSUE_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")
            
            # æå–æ ‡ç­¾ä¿¡æ¯
            LABELS=$(echo "$ISSUE_JSON" | jq -r '[.labels[].name] | join(", ")')
            LABEL_COUNT=$(echo "$ISSUE_JSON" | jq -r '.labels | length')
            
            # æå–åˆ†é…ä¿¡æ¯
            ASSIGNEES=$(echo "$ISSUE_JSON" | jq -r '[.assignees[].login] | join(", ")')
            ASSIGNEE_COUNT=$(echo "$ISSUE_JSON" | jq -r '.assignees | length')
            
            # æ„å»ºåˆå¹¶æ¶ˆæ¯
            ACTION_EMOJI="ğŸ“"
            ACTION_TEXT="æ–°å»ºäº† Issue"
            TITLE="$ACTION_EMOJI [${{ github.repository }}] $ACTION_TEXT"
            
            CONTENT="æ ‡é¢˜: $ISSUE_TITLE"
            CONTENT="$CONTENT | ä½œè€…: $ISSUE_AUTHOR"
            CONTENT="$CONTENT | ç¼–å·: #$ISSUE_NUMBER"
            CONTENT="$CONTENT | çŠ¶æ€: $ISSUE_STATE"
            
            # æ·»åŠ æ ‡ç­¾ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if [ "$LABEL_COUNT" -gt 0 ]; then
              if [ "$LABEL_COUNT" -eq 1 ]; then
                CONTENT="$CONTENT | æ ‡ç­¾: $LABELS"
              else
                CONTENT="$CONTENT | æ ‡ç­¾: $LABELS ($LABEL_COUNTä¸ª)"
              fi
            fi
            
            # æ·»åŠ åˆ†é…ä¿¡æ¯ï¼ˆå¦‚æœæœ‰ï¼‰
            if [ "$ASSIGNEE_COUNT" -gt 0 ]; then
              if [ "$ASSIGNEE_COUNT" -eq 1 ]; then
                CONTENT="$CONTENT | åˆ†é…ç»™: $ASSIGNEES"
              else
                CONTENT="$CONTENT | åˆ†é…ç»™: $ASSIGNEES ($ASSIGNEE_COUNTäºº)"
              fi
            fi
            
            echo "åˆå¹¶åçš„æ¶ˆæ¯ï¼ˆåŒ…å«$LABEL_COUNTä¸ªæ ‡ç­¾ï¼Œ$ASSIGNEE_COUNTä¸ªåˆ†é…ï¼‰"
            
          else
            # å¯¹äºé opened äº‹ä»¶ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨æ–°å»ºåçš„çŸ­æ—¶é—´å†…
            ISSUE_CREATED_AT="${{ github.event.issue.created_at }}"
            CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            # è®¡ç®—æ—¶é—´å·®ï¼ˆç§’ï¼‰
            CREATED_EPOCH=$(date -d "$ISSUE_CREATED_AT" +%s)
            CURRENT_EPOCH=$(date -d "$CURRENT_TIME" +%s)
            TIME_DIFF=$((CURRENT_EPOCH - CREATED_EPOCH))
            
            echo "Issue åˆ›å»ºäº: $ISSUE_CREATED_AT"
            echo "å½“å‰æ—¶é—´: $CURRENT_TIME"
            echo "æ—¶é—´å·®: $TIME_DIFF ç§’"
            
            # å¦‚æœ Issue æ˜¯2åˆ†é’Ÿå†…æ–°å»ºçš„ï¼ŒæŠ‘åˆ¶å•ç‹¬çš„æ ‡ç­¾/åˆ†é…äº‹ä»¶
            if [ "$TIME_DIFF" -lt 120 ]; then
              echo "æŠ‘åˆ¶çŸ­æ—¶é—´å†…çš„äº‹ä»¶: $ISSUE_ACTION (Issue åˆšåˆ›å»º)"
              echo "skip_notification=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            # æ­£å¸¸å¤„ç†å…¶ä»–äº‹ä»¶
            case "$ISSUE_ACTION" in
              "closed")
                ACTION_EMOJI="âœ…"
                ACTION_TEXT="å…³é—­äº† Issue"
                ;;
              "reopened")
                ACTION_EMOJI="ğŸ”„"
                ACTION_TEXT="é‡æ–°æ‰“å¼€äº† Issue"
                ;;
              "assigned")
                ACTION_EMOJI="ğŸ‘¤"
                ACTION_TEXT="åˆ†é…äº† Issue"
                ASSIGNEE="${{ github.event.issue.assignee.login }}"
                ;;
              "labeled")
                ACTION_EMOJI="ğŸ·ï¸"
                ACTION_TEXT="æ·»åŠ äº†æ ‡ç­¾"
                LABEL_NAME="${{ github.event.label.name }}"
                ;;
              "unlabeled")
                ACTION_EMOJI="ğŸ·ï¸"
                ACTION_TEXT="ç§»é™¤äº†æ ‡ç­¾"
                LABEL_NAME="${{ github.event.label.name }}"
                ;;
              *)
                ACTION_EMOJI="ğŸ“Œ"
                ACTION_TEXT="æ›´æ–°äº† Issue"
                ;;
            esac
            
            TITLE="$ACTION_EMOJI [${{ github.repository }}] $ACTION_TEXT"
            CONTENT="æ ‡é¢˜: $ISSUE_TITLE"
            CONTENT="$CONTENT | ä½œè€…: $ISSUE_AUTHOR"
            CONTENT="$CONTENT | ç¼–å·: #$ISSUE_NUMBER"
            
            case "$ISSUE_ACTION" in
              "assigned")
                CONTENT="$CONTENT | åˆ†é…ç»™: $ASSIGNEE"
                ;;
              "labeled")
                CONTENT="$CONTENT | æ ‡ç­¾: $LABEL_NAME"
                ;;
              "unlabeled")
                CONTENT="$CONTENT | æ ‡ç­¾: $LABEL_NAME"
                ;;
              *)
                CONTENT="$CONTENT | çŠ¶æ€: $ISSUE_STATE"
                ;;
            esac
          fi
          
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "content=$CONTENT" >> $GITHUB_OUTPUT
          echo "skip_notification=false" >> $GITHUB_OUTPUT
          
          echo "ç”Ÿæˆçš„æ¶ˆæ¯:"
          echo "æ ‡é¢˜: $TITLE"
          echo "å†…å®¹: $CONTENT"
      
      - name: Send QQ Notification
        if: steps.prepare_message.outputs.skip_notification != 'true'
        uses: Y2Nk4/qmsg-action@master
        with:
          qq: ${{ secrets.QMSG_NOTIFY_QQ }}
          groups: ${{ secrets.QMSG_NOTIFY_GROUPS }}
          key: ${{ secrets.QMSG_KEY }}
          message: |
            ${{ steps.prepare_message.outputs.title }}
            ${{ steps.prepare_message.outputs.content }}
      
      - name: Skip Notification Log
        if: steps.prepare_message.outputs.skip_notification == 'true'
        run: |
          echo "è·³è¿‡æ¨é€: ${{ github.event.action }} äº‹ä»¶è¢«æŠ‘åˆ¶"