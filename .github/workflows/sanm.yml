name: QQ Notification Sender

on:
  workflow_call:
    inputs:
      build_url:
        required: true
        type: string
      tag:
        required: true
        type: string
      is_dev_version:
        required: true
        type: string
      ci_as_stable:
        required: false
        type: boolean
        default: false
      commit_sha:
        required: true
        type: string
      commit_message:
        required: true
        type: string
      commit_timestamp:
        required: true
        type: string

jobs:
  send-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Extract commit info 
        id: commit-info
        run: |
          # ä½¿ç”¨æ›´å…¼å®¹çš„æ–¹æ³•å¤„ç†æäº¤ä¿¡æ¯
          COMMIT_MSG="${{ inputs.commit_message }}"
          
          # æå–ç¬¬ä¸€è¡Œä½œä¸ºæ‘˜è¦
          SUBJECT=$(echo "$COMMIT_MSG" | head -n 1)
          
          # æå–å‰©ä½™è¡Œä½œä¸ºæè¿°
          if [ $(echo "$COMMIT_MSG" | wc -l) -gt 1 ]; then
            BODY=$(echo "$COMMIT_MSG" | tail -n +2 | tr '\n' '|' | sed 's/|/ | /g')
          else
            BODY=""
          fi
          
          # æ ¼å¼åŒ–æ—¶é—´æˆ³
          TIME=$(date -d "${{ inputs.commit_timestamp }}" +"%Y-%m-%d %H:%M:%S")
          
          SHORT_SHA=$(echo "${{ inputs.commit_sha }}" | cut -c1-8)

          # è¾“å‡ºå˜é‡
          echo "subject=$SUBJECT" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
      
      - name: Send Notification
        uses: Y2Nk4/qmsg-action@master
        with:
          qq: ${{ secrets.QMSG_NOTIFY_QQ }}
          groups: ${{ secrets.QMSG_NOTIFY_GROUPS }}
          key: ${{ secrets.QMSG_KEY }}
          message: |
            ğŸ—ï¸ [${{ github.repository }}] æ„å»ºå®Œæˆ
            ğŸ‘¤ æäº¤è€…: ${{ github.actor }}
            ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}
            ğŸ·ï¸ ç‰ˆæœ¬: ${{ inputs.tag }}
            ğŸ“¦ ç±»å‹: ${{ contains(inputs.tag, '-beta') && 'å†…æµ‹ç‰ˆ' || (contains(inputs.tag, '-ci') && 'å¼€å‘ç‰ˆ' || 'æ­£å¼ç‰ˆ') }}
            ğŸ†” æäº¤å“ˆå¸Œ: ${{ steps.commit-info.outputs.short_sha }}
            â±ï¸ æäº¤æ—¶é—´: ${{ steps.commit-info.outputs.time }}
            ğŸ“ æ‘˜è¦: ${{ steps.commit-info.outputs.subject }}
            ğŸ“– æè¿°: ${{ steps.commit-info.outputs.body }}
            ğŸ”— æŸ¥çœ‹æäº¤: https://github.com/${{ github.repository }}/commit/${{ inputs.commit_sha }}
            ğŸ”¨ æ„å»ºä¸‹è½½: ${{ inputs.build_url }}