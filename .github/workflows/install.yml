name: install

on:
  push:
    tags:
      - "v*"
    branches:
      - "**"
    paths:
      - ".github/workflows/install.yml"
      - "assets/**"
      - "**.py"
  pull_request:
    branches:
      - "**"
    paths:
      - ".github/workflows/install.yml"
      - "assets/**"
      - "**.py"
  workflow_dispatch:
    inputs:
      deploy_beta:
        type: boolean
        description: 'å‘å¸ƒå†…æµ‹ç‰ˆ'
        default: false  # é»˜è®¤ä¸å‹¾é€‰ï¼Œé¿å…è¯¯è§¦
      ci_as_stable:
        type: boolean
        description: 'CIç‰ˆæœ¬ä½œä¸ºæ­£å¼å‘å¸ƒï¼ˆéé¢„å‘å¸ƒï¼‰'
        default: false

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: set_tag
        run: |
          # ä½¿ç”¨ç¯å¢ƒå˜é‡è·å–å¼•ç”¨ä¿¡æ¯
          is_tag_push=false
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            is_tag_push=true
          fi
          
          # è·å–æäº¤ä¿¡æ¯ï¼ˆç”¨äºæ£€æµ‹ [deploy-beta]ï¼‰
          commit_message="${{ github.event.head_commit.message }}"
          
          if [ "$is_tag_push" = true ]; then
            # æ­£å¼æ ‡ç­¾ï¼šç›´æ¥ä½¿ç”¨æ ‡ç­¾å
            tag="${GITHUB_REF#refs/tags/}"
            version_type="release"
          else
            # è·å–æœ€æ–°çš„æ­£å¼ç‰ˆæœ¬æ ‡ç­¾ï¼ˆåªåŒ¹é…çº¯ç²¹çš„æ­£å¼ç‰ˆï¼Œä¸åŒ…å«-betaæˆ–-ciï¼‰
            base_tag=$(git tag -l "v*" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)
            
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°çº¯ç‰ˆæœ¬å·æ ‡ç­¾ï¼Œä½¿ç”¨é»˜è®¤å€¼
            if [ -z "$base_tag" ] || [[ "$base_tag" != v*.*.* ]]; then
              base_tag="v0.0.0"
            fi
            
            commit_short=$(git rev-parse --short HEAD)
            date_suffix=$(date +"%y%m%d")
            
            # åˆ¤æ–­ç‰ˆæœ¬ç±»å‹
            if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ] && [ "${{ github.event.inputs.deploy_beta }}" = "true" ]; then
              # å†…æµ‹ç‰ˆï¼šåœ¨åŸºç¡€ç‰ˆæœ¬ä¸Šå¢åŠ è¡¥ä¸ç‰ˆæœ¬å·
              incremented_tag=$(echo "$base_tag" | awk -F. '{printf "%s.%s.%s", $1, $2, $3+1}')
              tag="${incremented_tag}-beta.${date_suffix}.${commit_short}"
              version_type="beta"
            elif echo "$commit_message" | tail -n1 | grep -q "\[deploy-beta\]"; then
              # å†…æµ‹ç‰ˆï¼šåœ¨åŸºç¡€ç‰ˆæœ¬ä¸Šå¢åŠ è¡¥ä¸ç‰ˆæœ¬å·
              incremented_tag=$(echo "$base_tag" | awk -F. '{printf "%s.%s.%s", $1, $2, $3+1}')
              tag="${incremented_tag}-beta.${date_suffix}.${commit_short}"
              version_type="beta"
            else
              # å¼€å‘ç‰ˆï¼šä½¿ç”¨åŸºç¡€ç‰ˆæœ¬å·ï¼Œä¸å¢åŠ è¡¥ä¸ç‰ˆæœ¬
              tag="${base_tag}-ci.${date_suffix}.${commit_short}"
              version_type="ci"
            fi
          fi
          
          # æ·»åŠ è°ƒè¯•ä¿¡æ¯
          echo "Base tag: $base_tag"
          echo "Generated tag: $tag"
          echo "Commit short: $commit_short"
          echo "Date suffix: $date_suffix"
          echo "Version type: $version_type"
          
          echo "tag=$tag" | tee -a $GITHUB_OUTPUT
          echo "is_tag_push=$is_tag_push" | tee -a $GITHUB_OUTPUT
          echo "is_dev_version=$([ "$version_type" = "ci" ] && echo "true" || echo "false")" | tee -a $GITHUB_OUTPUT
          echo "version_type=$version_type" | tee -a $GITHUB_OUTPUT
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
      is_tag_push: ${{ steps.set_tag.outputs.is_tag_push }}
      is_dev_version: ${{ steps.set_tag.outputs.is_dev_version }}
      version_type: ${{ steps.set_tag.outputs.version_type }}

  install:
    needs: meta
    runs-on: macos-latest
    strategy:
      matrix:
        os: [win, macos, linux, android]
        arch: [aarch64, x86_64]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      # æ–°å¢ï¼šè®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # æ–°å¢ï¼šå®‰è£… Python ä¾èµ–
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Download MaaFramework
        uses: robinraju/release-downloader@v1
        with:
          repository: MaaXYZ/MaaFramework
          fileName: "MAA-${{ matrix.os }}-${{ matrix.arch }}*"
          # latest: true
          # æŒ‡å®šMFAæ—§ç¨³å®šç‰ˆ
          tag: "v4.5.6"
          out-file-path: "deps"
          extract: true

      - name: Download MFAAvalonia
        if: matrix.os != 'android'
        id: download_mfa
        uses: robinraju/release-downloader@v1
        with:
          repository: SweetSmellFox/MFAAvalonia
          fileName: "MFAAvalonia-*-${{ (matrix.os == 'win' && 'win') || (matrix.os == 'macos' && 'osx') || (matrix.os == 'linux' && 'linux') }}-${{ (matrix.arch == 'x86_64' && 'x64') || (matrix.arch == 'aarch64' && 'arm64') }}*"
          latest: true
          out-file-path: "MFA"
          extract: true

      - name: Clean up MFAAvalonia archive
        if: matrix.os != 'android'
        shell: bash
        run: |
          ARCHIVE_FILE_PATH="${{ fromJson(steps.download_mfa.outputs.downloaded_files)[0] }}"
          rm -f "${ARCHIVE_FILE_PATH}"

      - name: Install
        shell: bash
        run: |
          python ./install.py ${{ needs.meta.outputs.tag }}

          if [[ "${{ matrix.os }}" != "android" ]]; then
            if [ -d "MFA" ]; then
              mkdir -p install
              rsync -av --ignore-existing MFA/ install/
            fi
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: MFABD2-${{ needs.meta.outputs.tag }}-${{ matrix.os }}-${{ matrix.arch }}
          path: "install"

  changelog:
    name: Generate changelog
    runs-on: ubuntu-latest
    needs: meta
    outputs:
      release_body: ${{ steps.set_release_body.outputs.content }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # âœ… ä½¿ç”¨æ–°ç³»ç»Ÿæ›¿æ¢git-cliff
      - name: Generate comprehensive changelog
        id: merge_changelog
        run: |
          cd scripts
          python changelog_generator.py
        env:
          CURRENT_TAG: ${{ needs.meta.outputs.tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}

      - name: Set release body
        id: set_release_body
        run: |
          content=$(cat CHANGES.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  release:
    if: (needs.meta.outputs.is_tag_push == 'true') || contains(needs.meta.outputs.tag, '-beta') || (github.event_name == 'workflow_dispatch' && contains(needs.meta.outputs.tag, '-ci'))
    needs: [meta, install, changelog]
    runs-on: ubuntu-latest
    steps:
      - name: Get current timestamp
        id: get_time
        run: echo "time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Package release assets
        run: |
          cd artifacts
          mkdir -p release_assets
          for dir in *; do
            # ç›´æ¥ä½¿ç”¨ç›®å½•åä½œä¸º zip æ–‡ä»¶å
            zip_name="${dir}.zip"
            
            # åˆ›å»ºå‹ç¼©åŒ…
            (cd "$dir" && zip -r "../release_assets/$zip_name" .)
          done
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/release_assets/*.zip
          tag_name: ${{ needs.meta.outputs.tag }}
          name: "MFABD2 ${{ needs.meta.outputs.tag }}"
          target_commitish: ${{ github.sha }}
          body: |
            ${{ contains(needs.changelog.outputs.release_body, '## ') && needs.changelog.outputs.release_body || '### æ— æ˜¾è‘—å˜æ›´' }}
            
          draft: false
          prerelease: ${{ contains(needs.meta.outputs.tag, '-beta') || (contains(needs.meta.outputs.tag, '-ci') && !(github.event_name == 'workflow_dispatch' && github.event.inputs.ci_as_stable == 'true')) }}
        env:  # æ·»åŠ ç¯å¢ƒå˜é‡ä»¥æ”¯æŒé«˜é™é¢APIè°ƒç”¨
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Trigger MirrorChyanUploading
        if: github.repository_owner == 'sunyink' && ((needs.meta.outputs.is_tag_push == 'true') || contains(needs.meta.outputs.tag, '-beta'))
        shell: bash
        env:
            tag: ${{ needs.meta.outputs.tag }}
            body: ${{ needs.changelog.outputs.release_body }}
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å®‰å…¨è§¦å‘é•œåƒæœåŠ¡: ç‰ˆæœ¬=$tag"
          # è§¦å‘åŒ…å‘å¸ƒæµç¨‹
          gh workflow run --repo $GITHUB_REPOSITORY --ref ${{ github.ref }} mirrorchyan.yml -f tag=$tag
          # è§¦å‘æ›´æ–°ä¿¡æ¯æ¨é€æµç¨‹
          gh workflow run --repo $GITHUB_REPOSITORY --ref ${{ github.ref }} mirrorchyan_release_note.yml -f tag=$tag -f body="$body"

  notify:
    needs: [meta, install]
    if: always() && needs.install.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Extract commit info 
        id: commit-info
        run: |
          # è°ƒè¯•ï¼šæ˜¾ç¤ºæ‰€æœ‰å¯ç”¨å‚æ•°
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          echo "GITHUB_EVENT_NAME: $GITHUB_EVENT_NAME"
          echo "HEAD_COMMIT_MESSAGE: ${{ github.event.head_commit.message }}"
          echo "HEAD_COMMIT_TIMESTAMP: ${{ github.event.head_commit.timestamp }}"
          echo "GITHUB_SHA: $GITHUB_SHA"
          
          # è®¾ç½®é»˜è®¤å€¼
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          if [ -z "$COMMIT_MSG" ]; then
            COMMIT_MSG="æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ"
          fi
          
          COMMIT_TIMESTAMP="${{ github.event.head_commit.timestamp }}"
          if [ -z "$COMMIT_TIMESTAMP" ]; then
            COMMIT_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          fi
          
          COMMIT_SHA="${{ github.sha }}"
          if [ -z "$COMMIT_SHA" ]; then
            COMMIT_SHA="unknown"
          fi
          
          # æå–ç¬¬ä¸€è¡Œä½œä¸ºæ‘˜è¦
          SUBJECT=$(echo "$COMMIT_MSG" | head -n 1)
          
          # ç®€åŒ–æè¿°å¤„ç†
          if [ $(echo "$COMMIT_MSG" | wc -l) -gt 1 ]; then
            BODY=$(echo "$COMMIT_MSG" | tail -n +2 | head -c 100 | tr -d '\n')
            if [ ${#BODY} -eq 100 ]; then
              BODY="$BODY..."
            fi
          else
            BODY=""
          fi
          
          # æ ¼å¼åŒ–æ—¶é—´æˆ³ä¸ºä¸œå…«åŒºæ—¶é—´
          TIME=$(TZ='Asia/Shanghai' date -d "$COMMIT_TIMESTAMP" +"%Y-%m-%d %H:%M:%S")
          
          SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)

          # è¾“å‡ºå˜é‡
          echo "subject=$SUBJECT" >> $GITHUB_OUTPUT
          echo "body=$BODY" >> $GITHUB_OUTPUT
          echo "time=$TIME" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          
          echo "=== å¤„ç†ç»“æœ ==="
          echo "Subject: $SUBJECT"
          echo "Body: $BODY" 
          echo "Time: $TIME"
          echo "Short SHA: $SHORT_SHA"
      
      - name: Send Notification
        uses: Y2Nk4/qmsg-action@master
        with:
          qq: ${{ secrets.QMSG_NOTIFY_QQ }}
          groups: ${{ secrets.QMSG_NOTIFY_GROUPS }}
          key: ${{ secrets.QMSG_KEY }}
          message: |
            ğŸ—ï¸ [${{ github.repository }}] æ„å»ºå®Œæˆ
            ğŸ‘¤ æäº¤è€…: ${{ github.actor }}
            ğŸŒ¿ åˆ†æ”¯: ${{ github.ref_name }}
            ğŸ·ï¸ ç‰ˆæœ¬: ${{ needs.meta.outputs.tag }}
            ğŸ“¦ ç±»å‹: ${{ contains(needs.meta.outputs.tag, '-beta') && 'å†…æµ‹ç‰ˆ' || (contains(needs.meta.outputs.tag, '-ci') && 'å¼€å‘ç‰ˆ' || 'æ­£å¼ç‰ˆ') }}
            ğŸ†” æäº¤å“ˆå¸Œ: ${{ steps.commit-info.outputs.short_sha }}
            â±ï¸ æäº¤æ—¶é—´: ${{ steps.commit-info.outputs.time }}
            ğŸ“ æ‘˜è¦: ${{ steps.commit-info.outputs.subject }}
            ${{ steps.commit-info.outputs.body != '' && format('ğŸ“– æè¿°: {0}', steps.commit-info.outputs.body) || 'ğŸ“– æè¿°: æ— ' }}
            ğŸ”— æŸ¥çœ‹æäº¤: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
            ğŸ”¨ æ„å»ºä¸‹è½½: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
