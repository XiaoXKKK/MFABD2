name: install

on:
  push:
    tags:
      - "v*"
    branches:
      - "**"
    paths:
      - ".github/workflows/install.yml"
      - "assets/**"
      - "**.py"
  pull_request:
    branches:
      - "**"
    paths:
      - ".github/workflows/install.yml"
      - "assets/**"
      - "**.py"
  workflow_dispatch:
    inputs:
      deploy_beta:
        type: boolean
        description: '发布内测版'
        default: false  # 默认不勾选，避免误触

jobs:
  meta:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: set_tag
        run: |
          # 使用环境变量获取引用信息
          is_tag_push=false
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            is_tag_push=true
          fi
          
          # 获取提交信息（用于检测 [deploy-beta]）
          commit_message="${{ github.event.head_commit.message }}"
          
          if [ "$is_tag_push" = true ]; then
            # 正式标签：直接使用标签名
            tag="${GITHUB_REF#refs/tags/}"
            version_type="release"
          else
            # 获取最新的正式版本标签（只匹配纯粹的正式版，不包含-beta或-ci）
            base_tag=$(git tag -l "v*" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -1)
            
            # 如果没有找到纯版本号标签，使用默认值
            if [ -z "$base_tag" ] || [[ "$base_tag" != v*.*.* ]]; then
              base_tag="v0.0.0"
            fi
            
            commit_short=$(git rev-parse --short HEAD)
            date_suffix=$(date +"%y%m%d")
            
            # 判断版本类型
            if [ "$GITHUB_EVENT_NAME" = "workflow_dispatch" ] && [ "${{ github.event.inputs.deploy_beta }}" = "true" ]; then
              # 内测版：在基础版本上增加补丁版本号
              incremented_tag=$(echo "$base_tag" | awk -F. '{printf "%s.%s.%s", $1, $2, $3+1}')
              tag="${incremented_tag}-beta.${date_suffix}.${commit_short}"
              version_type="beta"
            elif echo "$commit_message" | tail -n1 | grep -q "\[deploy-beta\]"; then
              # 内测版：在基础版本上增加补丁版本号
              incremented_tag=$(echo "$base_tag" | awk -F. '{printf "%s.%s.%s", $1, $2, $3+1}')
              tag="${incremented_tag}-beta.${date_suffix}.${commit_short}"
              version_type="beta"
            else
              # 开发版：使用基础版本号，不增加补丁版本
              tag="${base_tag}-ci.${date_suffix}.${commit_short}"
              version_type="ci"
            fi
          fi
          
          # 添加调试信息
          echo "Base tag: $base_tag"
          echo "Generated tag: $tag"
          echo "Commit short: $commit_short"
          echo "Date suffix: $date_suffix"
          echo "Version type: $version_type"
          
          echo "tag=$tag" | tee -a $GITHUB_OUTPUT
          echo "is_tag_push=$is_tag_push" | tee -a $GITHUB_OUTPUT
          echo "is_dev_version=$([ "$version_type" = "ci" ] && echo "true" || echo "false")" | tee -a $GITHUB_OUTPUT
          echo "version_type=$version_type" | tee -a $GITHUB_OUTPUT
    outputs:
      tag: ${{ steps.set_tag.outputs.tag }}
      is_tag_push: ${{ steps.set_tag.outputs.is_tag_push }}
      is_dev_version: ${{ steps.set_tag.outputs.is_dev_version }}
      version_type: ${{ steps.set_tag.outputs.version_type }}

  install:
    needs: meta
    runs-on: macos-latest
    strategy:
      matrix:
        os: [win, macos, linux, android]
        arch: [aarch64, x86_64]
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      # 新增：设置 Python 环境
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 新增：安装 Python 依赖
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Download MaaFramework
        uses: robinraju/release-downloader@v1
        with:
          repository: MaaXYZ/MaaFramework
          fileName: "MAA-${{ matrix.os }}-${{ matrix.arch }}*"
          latest: true
          out-file-path: "deps"
          extract: true

      - name: Download MFAAvalonia
        if: matrix.os != 'android'
        id: download_mfa
        uses: robinraju/release-downloader@v1
        with:
          repository: SweetSmellFox/MFAAvalonia
          fileName: "MFAAvalonia-*-${{ (matrix.os == 'win' && 'win') || (matrix.os == 'macos' && 'osx') || (matrix.os == 'linux' && 'linux') }}-${{ (matrix.arch == 'x86_64' && 'x64') || (matrix.arch == 'aarch64' && 'arm64') }}*"
          latest: true
          out-file-path: "MFA"
          extract: true

      - name: Clean up MFAAvalonia archive
        if: matrix.os != 'android'
        shell: bash
        run: |
          ARCHIVE_FILE_PATH="${{ fromJson(steps.download_mfa.outputs.downloaded_files)[0] }}"
          rm -f "${ARCHIVE_FILE_PATH}"

      - name: Install
        shell: bash
        run: |
          python ./install.py ${{ needs.meta.outputs.tag }}

          if [[ "${{ matrix.os }}" != "android" ]]; then
            if [ -d "MFA" ]; then
              mkdir -p install
              rsync -av --ignore-existing MFA/ install/
            fi
          fi

      - uses: actions/upload-artifact@v4
        with:
          name: MFABD2-${{ needs.meta.outputs.tag }}-${{ matrix.os }}-${{ matrix.arch }}
          path: "install"

  changelog:
    name: Generate changelog
    runs-on: ubuntu-latest
    needs: meta
    outputs:
      release_body: ${{ steps.set_release_body.outputs.content }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # ✅ 使用新系统替换git-cliff
      - name: Generate comprehensive changelog
        id: merge_changelog
        run: |
          cd scripts
          python changelog_generator.py
        env:
          CURRENT_TAG: ${{ needs.meta.outputs.tag }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}

      - name: Set release body
        id: set_release_body
        run: |
          content=$(cat CHANGES.md)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$content" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  release:
    if: (needs.meta.outputs.is_tag_push == 'true') || contains(needs.meta.outputs.tag, '-beta')
    needs: [meta, install, changelog]
    runs-on: ubuntu-latest
    steps:
      - name: Get current timestamp
        id: get_time
        run: echo "time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
      
      - uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Package release assets
        run: |
          cd artifacts
          mkdir -p release_assets
          for dir in *; do
            # 直接使用目录名作为 zip 文件名
            zip_name="${dir}.zip"
            
            # 创建压缩包
            (cd "$dir" && zip -r "../release_assets/$zip_name" .)
          done
          
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/release_assets/*.zip
          tag_name: ${{ needs.meta.outputs.tag }}
          name: "MFABD2 ${{ needs.meta.outputs.tag }}"
          body: |
            ${{ contains(needs.changelog.outputs.release_body, '## ') && needs.changelog.outputs.release_body || '### 无显著变更' }}
            
            **构建信息**:
            - 版本: `${{ needs.meta.outputs.tag }}`
            - 类型: ${{ needs.meta.outputs.version_type == 'release' && '正式版' || (needs.meta.outputs.version_type == 'beta' && '内测版' || '开发版') }}
            - 分支: ${{ github.ref_name }}
            - 构建时间: ${{ steps.get_time.outputs.time }}
          draft: false
          prerelease: ${{ contains(needs.meta.outputs.tag, '-beta') }}
        env:  # 添加环境变量以支持高限额API调用
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 获取完整历史
          ref: ${{ github.ref }}  # 确保检出正确引用

      - name: Trigger MirrorChyanUploading
        if: github.repository_owner == 'sunyink' && ((needs.meta.outputs.is_tag_push == 'true') || contains(needs.meta.outputs.tag, '-beta'))
        run: |
          echo "安全触发镜像服务: 版本=${{ needs.meta.outputs.tag }}"
          # 触发包发布流程
          gh workflow run mirrorchyan.yml -f target_version=${{ needs.meta.outputs.tag }}
          # 触发更新信息推送流程
          gh workflow run mirrorchyan_release_note.yml
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify:
    needs: [meta, install]
    if: always() && needs.install.result == 'success'
    uses: ./.github/workflows/sanm.yml
    with:
      build_url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
      tag: ${{ needs.meta.outputs.tag }}
      is_dev_version: ${{ needs.meta.outputs.is_dev_version }}
      commit_sha: ${{ github.sha }}
      commit_message: ${{ github.event.head_commit.message }}
      commit_timestamp: ${{ github.event.head_commit.timestamp }}
    secrets: inherit