name: Issue Summary Notification

on:
  schedule:
    # UTC Êó∂Èó¥ÂØπÂ∫îÂåó‰∫¨Êó∂Èó¥ +8
    - cron: '0 1 * * *'  # Âåó‰∫¨Êó∂Èó¥ 09:00
    - cron: '0 6 * * *'  # Âåó‰∫¨Êó∂Èó¥ 14:00  
    - cron: '0 10 * * *' # Âåó‰∫¨Êó∂Èó¥ 18:00
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'ÊµãËØïÊ®°ÂºèÔºöÊ±áÊÄªÂΩìÂ§©0ÁÇπËá≥‰ªäÁöÑÊ¥ªÂä®'
        required: false
        type: boolean
        default: false

env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  issue-summary:
    runs-on: ubuntu-latest
    steps:
      - name: Check Out Repository
        uses: actions/checkout@v4
      
      - name: Calculate Time Windows
        id: time_calc
        run: |
          # Ëé∑ÂèñÂΩìÂâçÊó∂Èó¥
          CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "current_time=$CURRENT_TIME" >> $GITHUB_OUTPUT
          
          # Â¶ÇÊûúÊòØÊâãÂä®Ëß¶ÂèëÁöÑÊµãËØïÊ®°Âºè
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.test_mode }}" == "true" ]; then
            # ÂΩìÂ§©0ÁÇπ UTC
            START_TIME=$(date -u -d "00:00:00" +"%Y-%m-%dT%H:%M:%SZ")
            TIME_LABEL="‰ªäÂ§©Ê±áÊÄª"
          else
            # Ê†πÊçÆÂÆöÊó∂‰ªªÂä°Á°ÆÂÆöÊó∂Èó¥Á™óÂè£
            CURRENT_HOUR=$(date -u +"%H")
            case $CURRENT_HOUR in
              "01")  # ÂØπÂ∫îÂåó‰∫¨Êó∂Èó¥ 09:00
                START_TIME=$(date -u -d "18:00:00 yesterday" +"%Y-%m-%dT%H:%M:%SZ")
                TIME_LABEL="Êò®Â§úÊ±áÊÄª"
                ;;
              "06")  # ÂØπÂ∫îÂåó‰∫¨Êó∂Èó¥ 14:00
                START_TIME=$(date -u -d "01:00:00" +"%Y-%m-%dT%H:%M:%SZ")
                TIME_LABEL="‰∏äÂçàÊ±áÊÄª"
                ;;
              "10")  # ÂØπÂ∫îÂåó‰∫¨Êó∂Èó¥ 18:00
                START_TIME=$(date -u -d "06:00:00" +"%Y-%m-%dT%H:%M:%SZ")
                TIME_LABEL="‰∏ãÂçàÊ±áÊÄª"
                ;;
              *)
                # ÈªòËÆ§ÊÉÖÂÜµÔºåÁî®‰∫éÊâãÂä®Ëß¶ÂèëÈùûÊµãËØïÊ®°Âºè
                START_TIME=$(date -u -d "6 hours ago" +"%Y-%m-%dT%H:%M:%SZ")
                TIME_LABEL="ËøëÊúüÊ±áÊÄª"
                ;;
            esac
          fi
          
          echo "start_time=$START_TIME" >> $GITHUB_OUTPUT
          echo "time_label=$TIME_LABEL" >> $GITHUB_OUTPUT
          echo "Time window: $START_TIME to $CURRENT_TIME"
          echo "Label: $TIME_LABEL"
      
      - name: Fetch Issue Activities
        id: fetch_activities
        env:
          START_TIME: ${{ steps.time_calc.outputs.start_time }}
          END_TIME: ${{ steps.time_calc.outputs.current_time }}
          REPO: ${{ github.repository }}
        run: |
          # ÂÆâË£Ö jq Áî®‰∫é JSON Â§ÑÁêÜ
          sudo apt-get update && sudo apt-get install -y jq
          
          echo "ÂºÄÂßãËé∑Âèñ GitHub Issue Ê¥ªÂä®Êï∞ÊçÆ..."
          echo "Êó∂Èó¥ËåÉÂõ¥: $START_TIME Âà∞ $END_TIME"
          echo "‰ªìÂ∫ì: $REPO"
          
          # ÊèêÂèñ‰ªìÂ∫ìÊâÄÊúâËÄÖÂíåÂ∞èÈº†
          REPO_OWNER=$(echo "$REPO" | cut -d'/' -f1)
          REPO_NAME=$(echo "$REPO" | cut -d'/' -f2)
          
          # Ëé∑ÂèñÊó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑ issue ËØÑËÆ∫
          COMMENTS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/issues/comments?since=$START_TIME&sort=created&direction=desc" | \
            jq -c '.[] | select(.created_at >= "'$START_TIME'" and .created_at <= "'$END_TIME'")')
          
          # Ëé∑ÂèñÊó∂Èó¥ËåÉÂõ¥ÂÜÖÁöÑ issue ‰∫ã‰ª∂ÔºàÊ†áÁ≠æÂèòÊõ¥„ÄÅÂàÜÈÖçÁ≠âÔºâ
          EVENTS_JSON=$(curl -s -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/$REPO/issues/events?since=$START_TIME" | \
            jq -c '.[] | select(.created_at >= "'$START_TIME'" and .created_at <= "'$END_TIME'")')
          
          # Â§ÑÁêÜËØÑËÆ∫Êï∞ÊçÆ
          COMMENT_COUNT=0
          COMMENTS_ARRAY="["
          
          if [ -n "$COMMENTS_JSON" ]; then
            while IFS= read -r comment; do
              if [ -n "$comment" ]; then
                ISSUE_NUMBER=$(echo "$comment" | jq -r '.issue_url | split("/") | last')
                ISSUE_TITLE=$(curl -s -H "Authorization: token $GH_TOKEN" \
                  -H "Accept: application/vnd.github.v3+json" \
                  "$(echo "$comment" | jq -r '.issue_url')" | jq -r '.title')
                AUTHOR=$(echo "$comment" | jq -r '.user.login')
                BODY=$(echo "$comment" | jq -r '.body' | sed 's/"/\\"/g')
                PREVIEW=$(echo "$BODY" | cut -c 1-15)
                
                if [ $COMMENT_COUNT -gt 0 ]; then
                  COMMENTS_ARRAY="$COMMENTS_ARRAY,"
                fi
                
                COMMENTS_ARRAY="$COMMENTS_ARRAY{\"number\": $ISSUE_NUMBER, \"title\": \"$ISSUE_TITLE\", \"author\": \"$AUTHOR\", \"preview\": \"$PREVIEW\"}"
                COMMENT_COUNT=$((COMMENT_COUNT + 1))
              fi
            done <<< "$COMMENTS_JSON"
          fi
          
          COMMENTS_ARRAY="$COMMENTS_ARRAY]"
          
          # Â§ÑÁêÜ‰∫ã‰ª∂Êï∞ÊçÆÔºàÊ†áÁ≠æÂèòÊõ¥„ÄÅÂàÜÈÖçÁ≠âÔºâ
          LABEL_COUNT=0
          LABELS_ARRAY="["
          ASSIGN_COUNT=0
          ASSIGNMENTS_ARRAY="["
          
          if [ -n "$EVENTS_JSON" ]; then
            while IFS= read -r event; do
              if [ -n "$event" ]; then
                EVENT_TYPE=$(echo "$event" | jq -r '.event')
                ISSUE_NUMBER=$(echo "$event" | jq -r '.issue.number')
                ISSUE_TITLE=$(echo "$event" | jq -r '.issue.title')
                
                case "$EVENT_TYPE" in
                  "labeled")
                    LABEL_NAME=$(echo "$event" | jq -r '.label.name')
                    if [ $LABEL_COUNT -gt 0 ]; then
                      LABELS_ARRAY="$LABELS_ARRAY,"
                    fi
                    LABELS_ARRAY="$LABELS_ARRAY{\"number\": $ISSUE_NUMBER, \"title\": \"$ISSUE_TITLE\", \"change\": \"Ê∑ªÂä†‰∫Ü$LABEL_NAMEÊ†áÁ≠æ\"}"
                    LABEL_COUNT=$((LABEL_COUNT + 1))
                    ;;
                  "unlabeled")
                    LABEL_NAME=$(echo "$event" | jq -r '.label.name')
                    if [ $LABEL_COUNT -gt 0 ]; then
                      LABELS_ARRAY="$LABELS_ARRAY,"
                    fi
                    LABELS_ARRAY="$LABELS_ARRAY{\"number\": $ISSUE_NUMBER, \"title\": \"$ISSUE_TITLE\", \"change\": \"ÁßªÈô§‰∫Ü$LABEL_NAMEÊ†áÁ≠æ\"}"
                    LABEL_COUNT=$((LABEL_COUNT + 1))
                    ;;
                  "assigned")
                    ASSIGNEE=$(echo "$event" | jq -r '.assignee.login')
                    if [ $ASSIGN_COUNT -gt 0 ]; then
                      ASSIGNMENTS_ARRAY="$ASSIGNMENTS_ARRAY,"
                    fi
                    ASSIGNMENTS_ARRAY="$ASSIGNMENTS_ARRAY{\"number\": $ISSUE_NUMBER, \"title\": \"$ISSUE_TITLE\", \"assignee\": \"$ASSIGNEE\"}"
                    ASSIGN_COUNT=$((ASSIGN_COUNT + 1))
                    ;;
                esac
              fi
            done <<< "$EVENTS_JSON"
          fi
          
          LABELS_ARRAY="$LABELS_ARRAY]"
          ASSIGNMENTS_ARRAY="$ASSIGNMENTS_ARRAY]"
          
          # ÁîüÊàêÊ±áÊÄªÊï∞ÊçÆ JSON
          cat > summary_data.json << EOF
          {
            "comments": $COMMENTS_ARRAY,
            "labels": $LABELS_ARRAY,
            "assignments": $ASSIGNMENTS_ARRAY
          }
          EOF
          
          TOTAL_COUNT=$((COMMENT_COUNT + LABEL_COUNT + ASSIGN_COUNT))
          
          echo "comment_count=$COMMENT_COUNT" >> $GITHUB_OUTPUT
          echo "label_count=$LABEL_COUNT" >> $GITHUB_OUTPUT  
          echo "assign_count=$ASSIGN_COUNT" >> $GITHUB_OUTPUT
          echo "total_count=$TOTAL_COUNT" >> $GITHUB_OUTPUT
          
          echo "Êï∞ÊçÆËé∑ÂèñÂÆåÊàê:"
          echo "ËØÑËÆ∫: $COMMENT_COUNT, Ê†áÁ≠æÂèòÊõ¥: $LABEL_COUNT, ÂàÜÈÖç: $ASSIGN_COUNT"
          cat summary_data.json 

      - name: Generate Summary Message
        id: generate_message
        env:
          TIME_LABEL: ${{ steps.time_calc.outputs.time_label }}
          COMMENT_COUNT: ${{ steps.fetch_activities.outputs.comment_count }}
          LABEL_COUNT: ${{ steps.fetch_activities.outputs.label_count }}
          ASSIGN_COUNT: ${{ steps.fetch_activities.outputs.assign_count }}
          TOTAL_COUNT: ${{ steps.fetch_activities.outputs.total_count }}
        run: |
          # ËØªÂèñÊ±áÊÄªÊï∞ÊçÆ
          SUMMARY_DATA=$(cat summary_data.json)
          
          # ÊûÑÂª∫Ê∂àÊÅØÂÜÖÂÆπ
          MESSAGE="üìä [${{ github.repository }}] IssueÂä®ÊÄÅ ($TIME_LABEL)"
          
          # Â§ÑÁêÜËØÑËÆ∫
          if [ $COMMENT_COUNT -gt 0 ]; then
            MESSAGE="$MESSAGE"$'\n'"üí¨ Êñ∞ËØÑËÆ∫ ($COMMENT_COUNT)"
            
            if [ $COMMENT_COUNT -eq 1 ]; then
              COMMENT=$(echo "$SUMMARY_DATA" | jq -r '.comments[0]')
              NUMBER=$(echo "$COMMENT" | jq -r '.number')
              TITLE=$(echo "$COMMENT" | jq -r '.title')
              AUTHOR=$(echo "$COMMENT" | jq -r '.author')
              PREVIEW=$(echo "$COMMENT" | jq -r '.preview' | cut -c 1-15)
              MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºö$AUTHORÔºö$PREVIEW..."
            elif [ $COMMENT_COUNT -le 3 ]; then
              for i in $(seq 0 $((COMMENT_COUNT-1))); do
                COMMENT=$(echo "$SUMMARY_DATA" | jq -r ".comments[$i]")
                NUMBER=$(echo "$COMMENT" | jq -r '.number')
                TITLE=$(echo "$COMMENT" | jq -r '.title')
                AUTHOR=$(echo "$COMMENT" | jq -r '.author')
                PREVIEW=$(echo "$COMMENT" | jq -r '.preview' | cut -c 1-15)
                MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºö$AUTHORÔºö$PREVIEW..."
              done
            else
              for i in $(seq 0 2); do
                COMMENT=$(echo "$SUMMARY_DATA" | jq -r ".comments[$i]")
                NUMBER=$(echo "$COMMENT" | jq -r '.number')
                TITLE=$(echo "$COMMENT" | jq -r '.title')
                AUTHOR=$(echo "$COMMENT" | jq -r '.author')
                PREVIEW=$(echo "$COMMENT" | jq -r '.preview' | cut -c 1-15)
                MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºö$AUTHORÔºö$PREVIEW..."
              done
              MESSAGE="$MESSAGE"$'\n'"  ...Á≠â$((COMMENT_COUNT-3))Êù°ËØÑËÆ∫"
            fi
          fi
          
          # Â§ÑÁêÜÊ†áÁ≠æÂèòÊõ¥
          if [ $LABEL_COUNT -gt 0 ]; then
            MESSAGE="$MESSAGE"$'\n'"üè∑Ô∏è Ê†áÁ≠æÂèòÊõ¥ ($LABEL_COUNT)"
            
            if [ $LABEL_COUNT -eq 1 ]; then
              LABEL=$(echo "$SUMMARY_DATA" | jq -r '.labels[0]')
              NUMBER=$(echo "$LABEL" | jq -r '.number')
              TITLE=$(echo "$LABEL" | jq -r '.title')
              CHANGE=$(echo "$LABEL" | jq -r '.change')
              MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºö$CHANGE"
            elif [ $LABEL_COUNT -le 3 ]; then
              for i in $(seq 0 $((LABEL_COUNT-1))); do
                LABEL=$(echo "$SUMMARY_DATA" | jq -r ".labels[$i]")
                NUMBER=$(echo "$LABEL" | jq -r '.number')
                TITLE=$(echo "$LABEL" | jq -r '.title')
                CHANGE=$(echo "$LABEL" | jq -r '.change')
                MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºö$CHANGE"
              done
            else
              for i in $(seq 0 2); do
                LABEL=$(echo "$SUMMARY_DATA" | jq -r ".labels[$i]")
                NUMBER=$(echo "$LABEL" | jq -r '.number')
                TITLE=$(echo "$LABEL" | jq -r '.title')
                CHANGE=$(echo "$LABEL" | jq -r '.change')
                MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºö$CHANGE"
              done
              MESSAGE="$MESSAGE"$'\n'"  ...Á≠â$((LABEL_COUNT-3))Êù°Ê†áÁ≠æÂèòÊõ¥"
            fi
          fi
          
          # Â§ÑÁêÜÂàÜÈÖç‰∫ã‰ª∂
          if [ $ASSIGN_COUNT -gt 0 ]; then
            MESSAGE="$MESSAGE"$'\n'"üë§ ÂàÜÈÖçÂèòÊõ¥ ($ASSIGN_COUNT)"
            
            if [ $ASSIGN_COUNT -eq 1 ]; then
              ASSIGN=$(echo "$SUMMARY_DATA" | jq -r '.assignments[0]')
              NUMBER=$(echo "$ASSIGN" | jq -r '.number')
              TITLE=$(echo "$ASSIGN" | jq -r '.title')
              ASSIGNEE=$(echo "$ASSIGN" | jq -r '.assignee')
              MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºöÂàÜÈÖçÁªô $ASSIGNEE"
            elif [ $ASSIGN_COUNT -le 3 ]; then
              for i in $(seq 0 $((ASSIGN_COUNT-1))); do
                ASSIGN=$(echo "$SUMMARY_DATA" | jq -r ".assignments[$i]")
                NUMBER=$(echo "$ASSIGN" | jq -r '.number')
                TITLE=$(echo "$ASSIGN" | jq -r '.title')
                ASSIGNEE=$(echo "$ASSIGN" | jq -r '.assignee')
                MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºöÂàÜÈÖçÁªô $ASSIGNEE"
              done
            else
              for i in $(seq 0 2); do
                ASSIGN=$(echo "$SUMMARY_DATA" | jq -r ".assignments[$i]")
                NUMBER=$(echo "$ASSIGN" | jq -r '.number')
                TITLE=$(echo "$ASSIGN" | jq -r '.title')
                ASSIGNEE=$(echo "$ASSIGN" | jq -r '.assignee')
                MESSAGE="$MESSAGE"$'\n'"  - [#$NUMBER] $TITLEÔºöÂàÜÈÖçÁªô $ASSIGNEE"
              done
              MESSAGE="$MESSAGE"$'\n'"  ...Á≠â$((ASSIGN_COUNT-3))Êù°ÂàÜÈÖçÂèòÊõ¥"
            fi
          fi
          
          # Â¶ÇÊûúÊ≤°ÊúâÊ¥ªÂä®
          if [ $TOTAL_COUNT -eq 0 ]; then
            MESSAGE="$MESSAGE"$'\n'"üì≠ Êú¨Êó∂ÊÆµÊó†Êñ∞Ê¥ªÂä®"
          fi
          
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
                
      - name: Send QQ Notification
        if: steps.fetch_activities.outputs.total_count != '0'
        uses: Y2Nk4/qmsg-action@master
        with:
          qq: ${{ secrets.QMSG_NOTIFY_QQ }}
          groups: ${{ secrets.QMSG_NOTIFY_GROUPS }}
          key: ${{ secrets.QMSG_KEY }}
          message: ${{ steps.generate_message.outputs.message }}      
