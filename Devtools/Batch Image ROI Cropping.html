<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡ç‰¹å¾å›¾æˆªå–å·¥å…· (ROI Cropper)</title>

    <script src="jszip.min.js"></script>
    <script src="FileSaver.min.js"></script>

    <script>
        if (typeof JSZip === 'undefined') {
            document.write('<script src="https://cdn.bootcdn.net/ajax/libs/jszip/3.10.1/jszip.min.js"><\/script>');
        }
        if (typeof saveAs === 'undefined') {
            document.write('<script src="https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"><\/script>');
        }
    </script>
    
    <style>
        :root { --bg: #1e1e1e; --text: #ddd; --accent: #4caf50; --panel: #2d2d2d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        h2 { margin-top: 0; color: var(--accent); }
        .container { display: flex; gap: 20px; width: 100%; max-width: 1200px; height: 80vh; }
        
        /* å·¦ä¾§æ§åˆ¶åŒº */
        .controls { flex: 1; display: flex; flex-direction: column; gap: 15px; background: var(--panel); padding: 20px; border-radius: 8px; }
        textarea { background: #111; color: #0f0; border: 1px solid #444; padding: 10px; font-family: monospace; height: 150px; resize: vertical; border-radius: 4px; }
        .drop-zone { border: 2px dashed #555; padding: 30px; text-align: center; cursor: pointer; transition: 0.3s; border-radius: 4px; }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: #333; }
        button { background: var(--accent); color: white; border: none; padding: 12px; cursor: pointer; font-size: 16px; border-radius: 4px; font-weight: bold; }
        button:disabled { background: #555; cursor: not-allowed; }
        .log { flex: 1; background: #111; padding: 10px; overflow-y: auto; font-family: monospace; font-size: 12px; border: 1px solid #444; color: #aaa; }
        
        /* å³ä¾§é¢„è§ˆåŒº */
        .preview-area { flex: 2; background: var(--panel); padding: 20px; border-radius: 8px; display: flex; flex-direction: column; }
        .preview-canvas-container { flex: 1; overflow: auto; border: 1px solid #444; background: #000; position: relative; display: flex; justify-content: center; align-items: center; }
        canvas { box-shadow: 0 0 10px rgba(0,0,0,0.5); max-width: 100%; }
        .status-bar { margin-top: 10px; font-size: 14px; color: #bbb; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <h2>ğŸ› ï¸ æ‰¹é‡ ROI ç‰¹å¾æˆªå–å·¥å…·</h2>

    <div class="container">
        <div class="controls">
            <div>
                <label>1. è¾“å…¥ ROI åˆ—è¡¨ (JSONæ ¼å¼)</label>
                <div style="font-size: 12px; color: #888; margin-bottom: 5px;">æ ¼å¼: [[x, y, w, h], [x, y, w, h]...]</div>
                <textarea id="roiInput" placeholder='Example: 
[
  [100, 200, 50, 50],
  [500, 300, 100, 80]
]'></textarea>
            </div>

            <div class="drop-zone" id="dropZone">
                <label>2. æ‹–å…¥å›¾ç‰‡æ–‡ä»¶ (æˆ–ç‚¹å‡»é€‰æ‹©)</label>
                <input type="file" id="fileInput" multiple accept="image/png, image/jpeg" style="display:none">
                <div id="fileCount" style="margin-top: 5px; color: var(--accent);">æœªé€‰æ‹©æ–‡ä»¶</div>
            </div>

            <button id="processBtn" disabled>å¼€å§‹æ‰¹é‡æˆªå–å¹¶ä¸‹è½½ ZIP</button>
            
            <div class="log" id="logArea">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <div class="preview-area">
            <div style="margin-bottom: 10px; font-weight: bold;">æœ€åä¸€å¼ å¤„ç†é¢„è§ˆ (åŠ ROI æ¡†ç¤º)</div>
            <div class="preview-canvas-container">
                <canvas id="previewCanvas"></canvas>
            </div>
            <div class="status-bar">
                <span id="progressText">è¿›åº¦: 0 / 0</span>
                <span id="zipSize">ZIPå¤§å°: 0 MB</span>
            </div>
        </div>
    </div>

<script>
    // å˜é‡åˆå§‹åŒ–
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const roiInput = document.getElementById('roiInput');
    const processBtn = document.getElementById('processBtn');
    const logArea = document.getElementById('logArea');
    const canvas = document.getElementById('previewCanvas');
    const ctx = canvas.getContext('2d');
    
    let files = [];
    let rois = [];

    // é»˜è®¤ ROI ç¤ºä¾‹
    roiInput.value = "[\n  [988, 122, 116, 116],\n  [1000, 300, 50, 50]\n]";

    // æ—¥å¿—å·¥å…·
    function log(msg) {
        const div = document.createElement('div');
        div.innerText = `> ${msg}`;
        logArea.appendChild(div);
        logArea.scrollTop = logArea.scrollHeight;
    }

    // 1. æ–‡ä»¶å¤„ç†é€»è¾‘
    dropZone.addEventListener('click', () => fileInput.click());
    
    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });
    
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
    });

    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

    function handleFiles(fileList) {
        files = Array.from(fileList).filter(f => f.type.startsWith('image/'));
        if (files.length > 0) {
            document.getElementById('fileCount').innerText = `å·²åŠ è½½ ${files.length} å¼ å›¾ç‰‡`;
            processBtn.disabled = false;
            processBtn.style.background = "#4caf50";
            log(`åŠ è½½äº† ${files.length} å¼ å›¾ç‰‡ã€‚è¯·ç¡®è®¤ ROI åç‚¹å‡»å¼€å§‹ã€‚`);
            
            // é¢„è§ˆç¬¬ä¸€å¼ å›¾
            previewImage(files[0]);
        }
    }

    // é¢„è§ˆå›¾ç‰‡å¹¶ç”»å‡º ROI æ¡†
    function previewImage(file) {
        const img = new Image();
        img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            // å°è¯•ç”» ROI
            try {
                const currentRois = JSON.parse(roiInput.value);
                ctx.strokeStyle = '#00ff00'; // ç»¿è‰²æ¡†
                ctx.lineWidth = 3;
                ctx.font = "20px Arial";
                ctx.fillStyle = "#00ff00";
                
                currentRois.forEach((roi, idx) => {
                    if(roi.length === 4) {
                        ctx.strokeRect(roi[0], roi[1], roi[2], roi[3]);
                        ctx.fillText(`ROI_${idx}`, roi[0], roi[1] - 5);
                    }
                });
            } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
            }
        };
        img.src = URL.createObjectURL(file);
    }

    // ROI è¾“å…¥æ¡†å˜åŒ–æ—¶åˆ·æ–°é¢„è§ˆ
    roiInput.addEventListener('input', () => {
        if(files.length > 0) previewImage(files[0]);
    });

    // 2. æ ¸å¿ƒå¤„ç†é€»è¾‘
    processBtn.addEventListener('click', async () => {
        // è§£æ ROI
        try {
            rois = JSON.parse(roiInput.value);
            if (!Array.isArray(rois) || rois.length === 0) throw new Error("æ ¼å¼é”™è¯¯");
        } catch (e) {
            alert("ROI æ ¼å¼é”™è¯¯ï¼è¯·è¾“å…¥ JSON æ•°ç»„ï¼Œä¾‹å¦‚ [[x,y,w,h]]");
            return;
        }

        processBtn.disabled = true;
        processBtn.innerText = "å¤„ç†ä¸­...";
        log("å¼€å§‹æ‰¹é‡å¤„ç†...");

        const zip = new JSZip();
        const folder = zip.folder("roi_crops");
        let processedCount = 0;

        // è¾…åŠ©å‡½æ•°ï¼šåŠ è½½å›¾ç‰‡
        const loadImage = (file) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = URL.createObjectURL(file);
            });
        };

        // è¾…åŠ©å‡½æ•°ï¼šè£å‰ªå¹¶è½¬ Blob
        const cropToBlob = (img, x, y, w, h) => {
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = w;
            cropCanvas.height = h;
            const cropCtx = cropCanvas.getContext('2d');
            
            // æ ¸å¿ƒï¼šæ— è®ºåŸå›¾å¤šå¤§ï¼Œåªå–å·¦ä¸Šè§’ç›¸å¯¹åæ ‡
            cropCtx.drawImage(img, x, y, w, h, 0, 0, w, h);
            
            return new Promise(resolve => {
                cropCanvas.toBlob(blob => resolve(blob), 'image/png');
            });
        };

        // å¾ªç¯å¤„ç†æ–‡ä»¶
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const safeName = file.name.replace(/\.[^/.]+$/, ""); // å»åç¼€
            
            try {
                const img = await loadImage(file);
                
                // å¯¹æ¯ä¸ª ROI è¿›è¡Œè£å‰ª
                for (let j = 0; j < rois.length; j++) {
                    const [x, y, w, h] = rois[j];
                    const blob = await cropToBlob(img, x, y, w, h);
                    
                    // æ–‡ä»¶å‘½å: åŸæ–‡ä»¶å_roiç´¢å¼•.png
                    folder.file(`${safeName}_roi${j}.png`, blob);
                }

                processedCount++;
                document.getElementById('progressText').innerText = `è¿›åº¦: ${processedCount} / ${files.length}`;
                
                // ç®€å•çš„å†…å­˜å›æ”¶
                URL.revokeObjectURL(img.src);

            } catch (err) {
                log(`é”™è¯¯: å¤„ç†æ–‡ä»¶ ${file.name} å¤±è´¥`);
                console.error(err);
            }
        }

        log("å›¾ç‰‡å¤„ç†å®Œæˆï¼Œæ­£åœ¨æ‰“åŒ… ZIP...");
        
        // ç”Ÿæˆ ZIP å¹¶ä¸‹è½½
        zip.generateAsync({type:"blob"}).then(function(content) {
            const sizeMB = (content.size / 1024 / 1024).toFixed(2);
            document.getElementById('zipSize').innerText = `ZIPå¤§å°: ${sizeMB} MB`;
            saveAs(content, "roi_features.zip");
            
            log(`âœ… å®Œæˆï¼å·²ä¸‹è½½ roi_features.zip (${sizeMB} MB)`);
            processBtn.disabled = false;
            processBtn.innerText = "å¼€å§‹æ‰¹é‡æˆªå–å¹¶ä¸‹è½½ ZIP";
        });
    });
</script>
</body>
</html>